---
title: >
  Using DoReMiTra for analyzing and integrating publicly available transcriptomics radiation datasets
subtitle: >
  Supplementary file for 'DoReMiTra: An R/Bioconductor data package for orchestrating the analysis of radiation transcriptomic studies'
author:
- name: Ahmed Salah
  affiliation: 
  - Department of Radiation Oncology and Radiation Therapy, Mainz, Germany
  - Institute of Medical Biostatistics, Epidemiology and Informatics (IMBEI), Mainz, Germany
  email: ahhassan@uni-mainz.de
- name: Sebastian Zahnreich
  affiliation: 
  - Department of Radiation Oncology and Radiation Therapy, Mainz, Germany
- name: Federico Marini
  affiliation: 
  - Institute of Medical Biostatistics, Epidemiology and Informatics (IMBEI), Mainz, Germany
  email: marinif@uni-mainz.de
date: "`r format(Sys.Date(), '%d %B %Y')`"
format:
  html:
    toc: true
    number-sections: true
    embed-resources: true
    mainfont: "Atkinson Hyperlegible"
    link-external-newwindow: true
    theme: 
    - cosmo
    - ummz_theme.scss
bibliography: DRMTS.bib
editor_options: 
  chunk_output_type: console
---

# Loading the libraries

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r loadlib, warning=FALSE}
library("DoReMiTra")
library("mosdef")
library("org.Hs.eg.db")
library("DESeq2")
library("ggplot2")
library("ComplexHeatmap")
library("VennDiagram")
library("limma")
library("circlize")
library("GeneTonic")
library("clusterProfiler")

```

# Searching Datasets

The user can use **`search_DoReMiTra_datasets()`** to filter the available DoReMiTra datasets based on metadata fields such as radiation type, organism, or experimental setting. This function helps narrow down datasets of interest before fetching them.

```{r search-datasets}

# X-ray datasets
search_DoReMiTra_datasets(radiation_type = "X-ray", 
                          organism = "Homo sapiens", 
                          exp_setting = "ExVivo")

# gamma ray datasets
search_DoReMiTra_datasets(radiation_type = "gamma ray", 
                          organism = "Homo sapiens", 
                          exp_setting = "ExVivo")
```

# Fetching Datasets

After selecting the dataset of interest, **`get_DoReMiTra_data()`** can be used to fetch a `SummarizedExperiment` (SE) object directly from ExperimentHub.

```{r load-dataset}

dataset_name_1 <- "SE_Salah_2025_ExVivo"

# we would like also to compare it to another dataset from another radiation type to see shared and distinct gene signatures

dataset_name_2 <- "SE_Paul_2013_ExVivo_GSE44201_GPL6848"


se1 <- get_DoReMiTra_data(dataset_name_1)
se2 <- get_DoReMiTra_data(dataset_name_2, gene_symbol = TRUE)

```

# Summarizing a Dataset

To quickly obtain a summary of an SE object, use **`summarize_DoReMiTra_se()`**, which provides a concise overview including the number of samples, genes, radiation types, and other metadata.

```{r summarize}

summarize_DoReMiTra_se(se1)

```

# Comparing the metadata of multiple Datasets

To compare key metadata information from two or more SE objects from the DoReMiTra collection, **`compare_DoReMiTra_datasets()`** summarizes key metadata information such as radiation type, dose, and time point.

```{r compare}

se_list<- list(
  Salah = se1, 
  Paul = se2
)
compare_DoReMiTra_datasets(se_list = se_list) |> kableExtra::kable()
```

# Once we retrieved the analysis-ready datasets of intereset, we can explore and analyse them

## X-ray dataset analysis

```{r PCA-plot}

# This dataset consists of 3 donors, 5 doses (0, 0.5, 1, 2, and 4Gy), and 2 timepoints (2h and 6h)

dds<- DESeqDataSet(se1, design = ~ +1)

dds$Dose <- factor(dds$Dose)

dds$Donors <- factor(dds$Donors)

dds$Dose <- relevel(dds$Dose, ref = "0Gy")

dds_t1 <- dds[, dds$Time_point == "2hrs"]

dds_t2 <- dds[, dds$Time_point == "6hrs"]


vsd_Salah <- vst(dds)

pca_plot <- plotPCA(vsd_Salah, 
                    intgroup = c("Donors", "Time_point"),
                    returnData = TRUE)

percentVar <- round(100 * attr(pca_plot, "percentVar"))

PCA<- ggplot(pca_plot, aes(x = PC1, y = PC2, color = Donors, shape = Time_point)) +
  geom_point(size = 3) +
  scale_shape_manual(values = c(16, 17)) + 
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +
  theme_minimal()+
  theme(plot.background = element_rect(fill = "white", color = NA))

PCA

```

Heatmap of the highly variable genes

```{r Heatmap}

vsd_t1 <- vst(dds_t1)

# as we have strong donor effect, we will account for it for better visualization

vsd_corrected <- vsd_t1
assay(vsd_corrected) <- limma::removeBatchEffect(assay(vsd_corrected), batch = vsd_corrected$Donors)

# Order columns by dose
doses <- as.numeric(sub("Gy.*", "", colnames(vsd_corrected)))
col_order <- order(doses)
vsd_corrected <- vsd_corrected[, col_order]

colnames(vsd_corrected)


top_n <- 50 

rv <- rowVars(assay(vsd_corrected))
top_genes <- order(rv, decreasing = TRUE)[1:top_n]

mat <- assay(vsd_corrected)[top_genes, ]
mat_scaled <- t(scale(t(mat)))
annotation <- as.data.frame(colData(vsd_corrected)[, c("Sex","Dose"), drop = FALSE])


Heatmap(mat_scaled,
        name = "expression",
        cluster_columns = F,
        top_annotation = HeatmapAnnotation(df = annotation))

```

Alternatively, one can also explore the datasets with DoReMiTraExplorer

The retrieved SE objects can be explored with **`DoReMiTra_explorer()`**, an interactive Shiny application for visualization and exploratory analysis of DoReMiTra datasets. This app allows users to examine transcriptomic responses to radiation using:

-   Principal component analysis (PCA)

-   Boxplots

-   Doseâ€“response gene plots

-   Heatmaps of highly variable genes

It provides flexibility for both high-level overviews and detailed inspection of radiation-induced transcriptional patterns.

Installing and loading the app

```{r Shiny-load}

# Install the DoReMiTra-explorer Shiny App

devtools::install_github("AhmedSAHassan/DoReMiTraExplorer")

#Load the DoReMiTra Explorer package

suppressWarnings(library("DoReMiTraExplorer"))

```

```{r run-app, eval=FALSE}

DoReMiTra_explorer(se1)
```

![](images/clipboard-3009620933.png)

As we see from the PCA plot, the donor and time effects are the main sources of variability. These factors should be accounted for in downstream statistical analyses. Specifically, we use in this case the DESeq2 statistical framework, and focus on the 2Gy vs 0Gy comparison

```{r x-ray-analysis}

design(dds_t1)<- ~ Donors + Dose

dds_t1 <- DESeq(dds_t1)

resultsNames(dds_t1)

# we will focus on one contrast here, 2Gy vs 0Gy

results_Salah<- results(dds_t1, 
                       name = "Dose_2Gy_vs_0Gy", 
                       alpha = 0.05)

summary(results_Salah)

result_Salah_sig <- as.data.frame(results_Salah)

result_Salah_sig <- result_Salah_sig[!is.na(result_Salah_sig$padj) & result_Salah_sig$padj <= 0.05, ]

results_Salah_shrink <- lfcShrink(dds_t1, 
                                 res = results_Salah, 
                                 coef = "Dose_2Gy_vs_0Gy")

# adding SYMBOL column

result_Salah_sig$SYMBOL <- mapIds(
  org.Hs.eg.db,
  keys = rownames(result_Salah_sig),
  column = "SYMBOL",
  keytype = "ENSEMBL",
  multiVals = "first"
)
```

We can also visualize the up and down regulated genes via volcano plot

```{r volcanoPlot}

volcPlot <- de_volcano(
  res_de = results_Salah_shrink,
  mapping = "org.Hs.eg.db",
  labeled_genes = 50,
  logfc_cutoff = 0
)

volcPlot

# As we see here the highest X-ray sensitive genes are CDKN1A, AEN, and CD83 upon 1Gy exposure
```

From this point, we can also perform a functional enrichment analysis to see what pathways are regulated

```{r xray-enrichment}

res_enrich_salah <- enrichGO(result_Salah_sig$SYMBOL,
                                keyType = "SYMBOL",
                                ont = "BP",
                                OrgDb = "org.Hs.eg.db",
                                pvalueCutoff = 0.05,
                                pAdjustMethod = "BH",
                                qvalueCutoff = 0.2,
                                minGSSize = 10,
                                maxGSSize = 500
)

res_enrich_salah_sig <- res_enrich_salah@result[res_enrich_salah@result$p.adjust <= 0.05, ]

# now we will also visualize the top 10 regulated pathways

# create GeneTonic object

library(GeneTonic)

anno_df <- get_annotation_orgdb(
  de_container = dds,
  orgdb_package = "org.Hs.eg.db",
  id_type = "ENSEMBL"
)


gtl <- GeneTonicList(
  dds = dds_t1,
  res_de = results_Salah,
  res_enrich = shake_enrichResult(res_enrich_salah),
  annotation_obj = anno_df
)

# preparing the matrix for heatmap

scored_mat <- GeneTonic::gs_scores(se = vsd_corrected, gtl = gtl)


anno <- as.data.frame(colData(vsd_corrected)[, c("Sex", "Dose")])

dose_colors <- colorRampPalette(c("lightyellow", "gold", "orange", "red"))(5)
names(dose_colors)<- c("0Gy", "0.5Gy", "1Gy", "2Gy", "4Gy")

anno_colors <- list(
  Sex = c(Female = "pink", Male = "blue"),
  Dose = dose_colors
)

column_annotation <- HeatmapAnnotation(
  Sex = anno$Sex,
  Dose = anno$Dose,
  col = anno_colors, show_legend = T
)


col_fun <- colorRamp2(
  c(-2, 0, 2),
  c("blue", "white", "red")
)

ht<-Heatmap(scored_mat[1:10,],
  name = "Expression",
  top_annotation = column_annotation,
  cluster_columns = F, # Optional: Cluster columns
  cluster_rows = F, # Optional: Cluster rows
  show_row_names = T,
  show_column_names = TRUE, 
  row_dend_side = "left",
  row_names_side = "left",
  row_names_gp = gpar(fontsize = 5, fontface= "bold" ),
  width = unit(7, "cm"),
  heatmap_height = unit(12, "cm"),
  column_names_gp = gpar(fontsize = 7),
  column_names_rot = 90,
  column_title = "Donors", 
  column_title_side = "bottom",
  show_heatmap_legend = T, 
  col = col_fun
)

draw(ht, heatmap_legend_side = "right", annotation_legend_side = "right")

# we can see here that the top 10 regulated pathways are related to DNA damage repair and immune response pathways

```

## gamma ray analysis

We might also want to compare Xray signature to gamma ray signatures to see if both ionizing radiation types have shared and distinct transcriptional responses we will therefore focus on Paul_2013 dataset since it has the same timepoint of Salah_2025

```{r gamma-ray-analysis}

# In se2 dataset, Age and Sex should be accounted for to capture signals only in response to radiation

# For comparability, we will only focus on 6hr timepoint

se2_t1 <- se2[, colData(se2)$Time_point == "6hr"]
# since it is a repeated measurements experiment, we will create a pseudo-donor factor to account for interdonor variability

expr <- assay(se2_t1)
# Remove probes with NA values
expr <- expr[rowSums(is.na(expr)) == 0, ]

# Remove probes with zero variance
expr <- expr[apply(expr, 1, sd) != 0, ]

# extracting metadata
meta <- as.data.frame(colData(se2_t1))

# Number of donors
n_donors <- 5
# Number of doses per donor
n_doses <- 5

# Create pseudo-donor factor
meta$Donors <- factor(rep(1:n_donors, each = n_doses))

# Check
table(meta$Donors)

# Factor the covariates
meta$Dose <- factor(meta$Dose)
meta$Dose <- relevel(meta$Dose, ref = "0Gy")
meta$Sex  <- factor(meta$Sex)
meta$Age <- as.numeric(gsub("[^0-9]", "", meta$Age))



# Building the design
design <- model.matrix(~ Age + Sex + Dose, data = meta)
design

# Blocking the donor effect
corfit <- duplicateCorrelation(expr, design, block = meta$Donors)

# Fit the model
fit <- lmFit(expr, design, block = meta$Patient, correlation = corfit$consensus)

contrast.matrix <- makeContrasts(Dose2Gy, levels = design)


fit2 <- contrasts.fit(fit, contrast.matrix)
fit2 <- eBayes(fit2)

# extracting the results
results_Paul <- topTable(fit2, number = Inf)
results_Paul_sig <- results_Paul[ results_Paul$adj.P.Val<= 0.05,]

# Here we will extract the gene symbol part without the probe id so we can compare the genes with the Salah_2025 dataset

results_Paul_sig$SYMBOL <- sub("_.*", "", rownames(results_Paul_sig))

# again, we can also check this effect at the pathway level

res_enrich_paul <- enrichGO(results_Paul_sig$SYMBOL,
                                keyType = "SYMBOL",
                                ont = "BP",
                                OrgDb = "org.Hs.eg.db",
                                pvalueCutoff = 0.05,
                                pAdjustMethod = "BH",
                                qvalueCutoff = 0.2,
                                minGSSize = 10,
                                maxGSSize = 500
)

res_enrich_paul_sig <- res_enrich_paul@result[res_enrich_paul@result$p.adjust <= 0.05, ]

# Similarly to X-ray dataset from Salah_2025, the regulated pathways were mainly involved in DNA damage and immune responses.

```

Checking the shared genes between both radiation types, at the same timepoint and radiation dose

```{r compare-datasets}

result_Salah_sig<- na.omit(result_Salah_sig)

# Venndiagram
venn.plot <- venn.diagram(
  x = list(
    Salah = result_Salah_sig$SYMBOL,
    Paul = results_Paul_sig$SYMBOL
  ),
  filename = NULL,  # Plot to R directly
  fill = c("#8da0cb", "orange"),
  alpha = 0.6,
  cat.cex = 1.2,
  cex = 1.5,
  main = "Shared and Distinct signature"
)

grid::grid.draw(venn.plot)

# shared signature between X and gamma rays

intersect(result_Salah_sig$SYMBOL, results_Paul_sig$SYMBOL)

# gamma-ray only signature

setdiff(results_Paul_sig$SYMBOL, result_Salah_sig$SYMBOL)

# X-ray only signature

setdiff(result_Salah_sig$SYMBOL, results_Paul_sig$SYMBOL)

```

# Session info {-}

```{r sessioninfo}
sessionInfo()
```
